Analysis & Plotting
================
Jonathan E. Falciani[^1]
01 November 2022

# Aim and Scope

The purpose of this document is to analyze and plot the results of our
trials. Most of these plots will be produced as seen in the paper with
some edits made in Adobe Illustrator. These plots include the
distribution of each strategy in terms of biomass and yield, averaged
size spectra from the yield intervals, the correlation bar graph, and
the size spectrum methods figure.

First we need to load in the `mizer`
[package](https://sizespectrum.org/mizer).

``` r
library(mizer)
```

Run `devtools::load_all` in order to load all of the necessary functions
inside the `fishcarbon` R project. If you are not, then see the
functions vignette for the functions needed.

``` r
devtools::load_all("./", export_all = TRUE)
```

The other R packages needed are:

``` r
library(here)
library(tidyverse)
library(corrplot)
library(cowplot)
library(gridExtra)
library(scales)
library(mgcv)
```

$~$

First, we must load in the data generated by the randomization process.

``` r
strategies_df <- read.csv(file.path(here(), 'data',
                                    'fishcarbon_metrics_9sp.csv'),header = TRUE)
```

This is where we specify the initial parameters for our fisheries. We
use the number of fish in the ecosystem with `no.fish`, the number of
fisheries (groups) with `no.fishery`, and the number of fish in each
fishery with `no.fish.fishery`.

``` r
no.fish = 9
no.fishery = 3
no.fish.fishery = no.fish / no.fishery
```

We use the residuals in relation to a GAM to define optimal versus
suboptimal strategies. This provides a North-South relationship that
controls for yield while allowing biomass to vary. The GAM also provides
a mean estimate to make generalizations about the trend between biomass
and yield.

``` r
model1 <- gam(formula = strategies_df$B ~ s(strategies_df$Y, bs = "cs"), method = "REML")
strategies_df$residuals <- residuals(model1, type = "deviance")
```

We define the **conservation subset** as a subset of all strategies in
which there are no species extirpations (an extirpation is defined by
$B_{SSB} < 10\%$ for a species).

``` r
strategies_df.noE <- filter(strategies_df, E == 0)
```

The residuals are distributed in the following way, in which all of the
strategies have a spread of roughly 25% of the total biomass, and the
conservation subset (strategies where `E == 0`) have a spread of roughly
15%.

``` r
g.residuals <- ggplot(strategies_df, aes(residuals)) +
  geom_histogram(data = strategies_df) +
  scale_x_continuous(name = "Residuals") +
  scale_y_continuous(name = "Count") +
  guides(color = guide_colorbar(ticks.colour = "black", frame.colour = "gray50", barwidth = 0.5, title.hjust = 5)) +
  theme_light() +
  theme(legend.position = c(.93, .65),
        legend.background = element_rect(fill = alpha(0.8)),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.residuals <- g.residuals +
  geom_histogram(data = strategies_df.noE, aes(residuals), fill = "black")

g.residuals
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/residual%20histogram-1.png)<!-- -->

![residual histogram plot](/figures/020_analysis/residual-histogram.png)

$~$

# Biomass vs Yield Plot

This plot forms the crux of our study. It demonstrates that there is
scope to develop possible strategies that maintain a yield in protein,
but retain carbon in the living tissues of fish as standing stock
biomass. We will divide this figure creation into three parts:

1.  the biomass vs yield plot, where each axis is normalized by the
    total biomass of the unfished strategy
2.  the interval relative size spectra plots corresponding to the top &
    bottom 20% in the designated intervals in the biomass vs yield plot

``` r
colors1 <- c('#0571b0', '#0571b0', '#92c5de', '#f7f7f7', '#f4a582', '#ca0020', '#ca0020')
values1 <- c(0.0, 0.1, 0.18, 0.39, 0.54, 0.67, 1)

#biomass vs yield plot
g.BvY <- ggplot(strategies_df, aes(x=Y, y=B, color=residuals)) +
  annotate("rect", xmin = 0.18, xmax = 0.22, ymin = -Inf, ymax = Inf, color = NA, fill = "gray60", alpha = 0.3) +
  annotate("rect", xmin = 0.38, xmax = 0.42, ymin = -Inf, ymax = Inf, color = NA, fill = "gray60", alpha = 0.3) +
  annotate("rect", xmin = 0.58, xmax = 0.62, ymin = -Inf, ymax = Inf, color = NA, fill = "gray60", alpha = 0.3) +
  annotate("rect", xmin = 0.78, xmax = 0.82, ymin = -Inf, ymax = Inf, color = NA, fill = "gray60", alpha = 0.3) +
  geom_point() +
  #ggtitle("Average annual yield versus average annual biomass at equilibrium") +
  geom_smooth(method = 'gam', color = "black", se = FALSE) +
  scale_color_gradientn("Residuals", colors = colors1, values = values1) +
  scale_x_continuous(name = expression("Yield (Y / "*B[U] *")"), breaks = seq(0, 2, .2), expand = c(0, 0)) +
  scale_y_continuous(name = expression("Biomass (B / "*B[U] *")"), breaks = seq(0, 2, .2)) +
  labs(tag = "(a)") +
  guides(color = guide_colorbar(ticks.colour = "black", frame.colour = "gray50", barwidth = 0.5, title.hjust = 5)) +
  theme_light() +
  theme(legend.position = c(.93, .65),
        plot.margin = grid::unit(c(0,0,0,0), "mm"),
        legend.background = element_rect(fill = alpha(0.8)),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.BvY <- g.BvY +
  geom_density_2d(data = strategies_df.noE,
                  aes(x = Y, y = B), 
                  breaks = c(0.1), color = "black", alpha = 0.8) +
  geom_point(aes(x = 0.01, y = 1), color = "black", shape = 15, size = 3)

g.BvY
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/BvY%20plot-1.png)<!-- -->
![BvY plot](/figures/020_analysis/BvY-plot.png)

This loop averages each $F$ and $S$ among the top 20% (optimal) and the
bottom 20% (suboptimal) of each yield interval grayed out in the biomass
vs yield figure. The corresponding $F$ and $S$ are then applied to the
community and the realative size spectrum is found by normalizing by the
unfished spectrum.

``` r
# Unfished simulation
S.list <- rep(.01, 3)
F.list <- rep(0, 3)
params <- newTraitParams(no_sp = no.fish)
gear_params(params) <- data.frame(species = species_params(params)$species,
                                  gear = c(rep("small", no.fish.fishery), rep("medium", no.fish.fishery), rep("large", no.fish.fishery)),
                                  sel_func = "knife_edge",
                                  sel = rep(S.list, each = no.fish.fishery),
                                  knife_edge_size = species_params(params)$w_inf * rep(S.list, each = no.fish.fishery))
sim0 <- project(params, t_max = 300, effort = c("small" = F.list[1],
                                                "medium" = F.list[2],
                                                "large" = F.list[3]))

# Loop for optimal & suboptimal strategies in each interval
lower.breaks <- c(0.18, 0.38, 0.58, 0.78)
upper.breaks <- c(0.22, 0.42, 0.62, 0.82)

relative.NvsW_df <- data.frame(w = numeric(),
                                    relative.N = numeric(),
                                    type = character(),
                                    interval = integer())

for (i in 1:4)
{
  lower.break <- lower.breaks[i]
  upper.break <- upper.breaks[i]
  
  relative.NvsW_df_tmp <- BvY_intervals(strategies_df, sim0, no.fish.fishery, lower.break = lower.break, upper.break = upper.break) %>%
    mutate(interval = i)
  
  relative.NvsW_df <- bind_rows(relative.NvsW_df, relative.NvsW_df_tmp)
}
```

Here, we plot the relative spectra for each interval, showing both the
optimal and suboptimal spectra.

``` r
g.NvsW <- relative.NvsW_df %>%
  ggplot(aes(x = w, y = relative.N, group = type)) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_line(aes(color = type, size = type)) +
  scale_color_manual(values = c("#ca0020", "#0571b0")) +
  scale_size_manual(values = c(1, 0.5)) +
  coord_cartesian(ylim = c(0.1, 10)) +
  scale_y_log10(name = expression("Biomass (B / "*B[U] *")")) +
  scale_x_log10(name = "Weight [g]", expand = c(0,0),
                labels = c("1 g", "1 kg"),
                breaks = c(1e+00, 1e+03)) +
  labs(tag = "(b)") +
  annotation_logticks(color = "gray50") +
  facet_wrap(~interval, nrow = 1) +
  theme_light() +
  theme(legend.position = c(0.80, -0.22),
        plot.margin = grid::unit(c(0,0,0,0), "mm"),
        legend.background = element_rect(fill = alpha(0.8)),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        strip.background = element_blank(),
        strip.text = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.NvsW
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/size%20spectra%20figures-1.png)<!-- -->
![size spectra plot](/figures/020_analysis/size-spectra-figures.png)

Now we put both plots together to get the published figure. Edits were
then made in Adobe Illustrator.

``` r
g.main <- grid.arrange(g.BvY, g.NvsW, nrow = 2, heights = c(3, 1.75))
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/BvY%20main%20figure-1.png)<!-- -->

``` r
ggsave("BvY.pdf",
  plot = g.main,
  device = "pdf",
  path = file.path(here(), "figures"))
```

![BvY main plot](/figures/020_analysis/BvY-main-figure.png)

$~$

# Correlation

The following plot shows the correlation of each of the input controls
($F_i$, $S_i$) and the community properties using the `corrplot`
package. Significance is determined by an M-test and a p-value of 0.01.
The x’s denote when a correlation is deemed insignificant.

``` r
library(corrplot)

# Full data & plotting
strategies_df_cor <- cor(strategies_df)
strategies_df_cor.mtest <- cor.mtest(strategies_df, conf.level = 0.95)

corrplot(strategies_df_cor, method = 'square', type = 'lower',
         p.mat = strategies_df_cor.mtest$p, sig.level = 0.01,
         tl.col = "black", tl.srt = 45, tl.cex = 0.8)
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/initial%20corrplot-1.png)<!-- -->

``` r
# Conservation subset
strategies_df.NoE_cor <- cor(strategies_df.noE)
strategies_df.NoE_cor.mtest <- cor.mtest(strategies_df.noE, conf.level = 0.95)
corrplot(strategies_df.NoE_cor, method = 'square', type = 'lower',
         p.mat = strategies_df.NoE_cor.mtest$p, sig.level = 0.01,
         tl.col = "black", tl.srt = 45, tl.cex = 0.8)
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/initial%20corrplot-2.png)<!-- -->
![corrplot 1 plot](/figures/020_analysis/initial-corrplot-1.png)
![corrplot 2 plot](/figures/020_analysis/initial-corrplot-2.png)

We are primarily interested in the relationship between the residuals
and other properties. For presentation in the paper, we present only
these correlations, filtering down to a select few properties that are
particularly illustrative.

``` r
interesting.variables <- c("F_small", "F_med", "F_large", "S_small", "S_med", "S_large", "E", "E_small", "E_med", "E_large",  "Bflux", "Wmean")

strategies_df_cor_df <- rownames_to_column(melt(strategies_df_cor["residuals", interesting.variables])) %>%
  mutate(p = strategies_df_cor.mtest[["p"]]["residuals", interesting.variables],
         LCI = strategies_df_cor.mtest[["lowCI"]]["residuals", interesting.variables],
         UCI = strategies_df_cor.mtest[["uppCI"]]["residuals", interesting.variables],
         p.x = ifelse(p > 0.01, value, NA),
         type = "all")

strategies_df.NoE_cor_df <- rownames_to_column(melt(strategies_df.NoE_cor["residuals", interesting.variables])) %>%
  mutate(p = strategies_df.NoE_cor.mtest[["p"]]["residuals", interesting.variables],
         LCI = strategies_df.NoE_cor.mtest[["lowCI"]]["residuals", interesting.variables],
         UCI = strategies_df.NoE_cor.mtest[["uppCI"]]["residuals", interesting.variables],
         p.x = ifelse(p > 0.01, value, NA),
         type = "conservation")
```

``` r
variable.labs <- c(expression(F[small]), expression(F[medium]), expression(F[large]),
                   expression(S[small]), expression(S[medium]), expression(S[large]),
                   "E", expression(E[small]), expression(E[medium]), expression(E[large]),
                   expression(B[flux]), expression(w[mean]))
  
colors2 <- c('#0571b0', '#f7f7f7', '#ca0020')
values2 <- c(0.0, 0.5, 1)

g.corr <- strategies_df_cor_df %>%
  ggplot(aes(x = rowname, y = value, fill = value)) +
  geom_hline(yintercept = 0, linetype = 'dotted', color = 'gray30') +
  geom_vline(xintercept = 3.5, linetype = 'dotted') +
  geom_vline(xintercept = 6.5, linetype = 'dashed') +
  geom_bar(stat = "identity", width = 0.65, size = .5, color = "gray50") +
  #geom_point(aes(x = rowname, y = p.x), shape = 4, size = 3) +
  geom_errorbar(aes(ymin = LCI, ymax = UCI), position = position_dodge(width = 0.7),
                width = 0.2, color = "black") +
  scale_fill_gradientn(colors = alpha(colors2, 0.9), values = values2, limits = c(-1, 1)) +
  scale_x_discrete(name = NULL,
                   limits = interesting.variables,
                   labels = variable.labs) +
  scale_y_continuous(name = "Correlation Coefficient") +
  annotate("text", label = "Fishing mortality", x = 2, y = 0.95, hjust = "center", family = "serif", size = 3.5) +
  annotate("text", label = "Selectivity", x = 5, y = 0.95, hjust = "center", family = "serif", size = 3.5) +
  annotate("text", label = "Community properties", x = 9.5, y = 0.95, hjust = "center", family = "serif", size = 3.5) +
  guides(fill = guide_colorbar(ticks.colour = "black", frame.colour = "gray50", barwidth = 0.5, title = NULL)) +
  theme_light() +
  theme(legend.position = "none",
        axis.title = element_text(size = 12, color = 'black'),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1, color = 'black'),
        axis.text.y = element_text(),
        plot.title = element_text(hjust = 0.5, size = 14),
        panel.grid.major.x = element_blank(),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.corr <- g.corr +
  geom_point(data = strategies_df.NoE_cor_df, aes(x = rowname, y = value), size = 2) +
  geom_point(data = strategies_df.NoE_cor_df, aes(x = rowname, y = p.x), shape = 4, size = 3)

g.corr
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/residuals%20correlation-1.png)<!-- -->

``` r
ggsave("corr.pdf",
  plot = g.corr,
  device = "pdf",
  path = file.path(here(), "figures"))
```

![residuals correlation
plot](/figures/020_analysis/residuals-correlation.png)

$~$

# Methods

Some of the figures referenced in the methods were produced solely
within Adobe Illustrator. However, the example size spectrum was
produced (mostly) using R. The figure represents the class-specific
fishing pressure applied on a species-specific basis and the shift in
the size spectrum that it produces. We find the natural biomass
distribution where there is no fishing in `sim0`. We then provide an
example fishing strategy in `sim1`.

``` r
# Unfished spectrum data
sim0.data <- plotSpectra(sim0, total = TRUE, return_data = TRUE)

# Fished spectrum data (we only collect the total here, not each species)
F_vec <- c(1, 0.8, 0.2)
S_vec <- c(0.2, 0.5, 0.7)

gear_params(params)$sel <- rep(S_vec, each = 3)
gear_params(params)$knife_edge_size <- species_params(params)$w_inf * gear_params(params)$sel
sim1 <- project(params, t_max = 300, effort = c("small" = F_vec[1],
                                                "medium" = F_vec[2],
                                                "large" = F_vec[3]))

sim1.data <- plotSpectra(sim1, total = TRUE, return_data = TRUE) %>%
  filter(Species == "Total")
```

First, we produce the size spectrum. The gray size spectrum shows the
distribution of fish biomass when it is left naturally. The black size
spectrum shows the distribution of fish biomass under the example
fishing scheme in `sim1`.

``` r
g.sim0.spectrum <- ggplot(sim0.data, aes(x = w, y = value)) +
  scale_x_log10(name = "Weight [g]", expand = c(0,0),
                labels = trans_format('log10', math_format(10^.x)),
                breaks = c(1e-01, 1e+00, 1e+01, 1e+02, 1e+03, 1e+04)) +
  scale_y_log10(name = "Biomass density", expand = c(0,0),
                labels = trans_format('log10', math_format(10^.x)),
                breaks = c(1e-07, 1e-06, 1e-05, 1e-04, 1e-03)) +
  geom_line(aes(group = Species,
                      colour = Species, size = Species)) +
  scale_color_manual(values = c(rep("gray70", 9), "green", "gray70")) +
  scale_size_manual(values = c(rep(0.5, 9), 1, 2)) + 
  annotation_logticks(color = "gray50", sides = "tbl") +
  coord_cartesian(xlim = c(1e-01, 1e+04), ylim = c(1e-07, 1e-02)) +
  theme_light() +
  theme(plot.margin = grid::unit(c(0,3,0,0), "mm"),
        legend.position = "none",
        legend.background = element_rect(fill = alpha(0.8)),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        strip.background = element_blank(),
        strip.text = element_blank(),
        panel.border = element_rect(color = "gray50"),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.spectrum <- g.sim0.spectrum +
  geom_line(data = sim1.data, aes(x = w, y = value),
            color = "white", size = 2.5) +
  geom_line(data = sim1.data, aes(x = w, y = value),
            color = "black", size = 2)

g.spectrum
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/unfished%20spectrum-1.png)<!-- -->
![unfished spectrum plot](/figures/020_analysis/unfished-spectrum.png)

Next, we produce the figure representing the example fishing pattern.
Each line corresponds to a fish species. The height of the line
corresponds to the fishing mortality $F$. The width of the line
represents the proportion of sizes in relation to $W_\infty$ that are
being harvested for each species $S$.

``` r
sim1.Fmortdata <- plotFMort(sim1, return_data = TRUE)

g.fishing <- ggplot(sim1.Fmortdata, aes(x = w, y = value)) +
  scale_x_log10(name = "Weight (g)", expand = c(0,0),
                labels = trans_format('log10', math_format(10^.x)),
                breaks = log_breaks()) +
  scale_y_continuous(name = "F", expand = c(0,0),
                     breaks = seq(0, 2, by = 0.1),
                     labels = c(0, rep("", 4), 0.5, rep("", 4), 1, rep("", 4), 1.5, rep("", 4), 2)) +
  geom_line(aes(group = Species,
                colour = Species, size = Species)) +
  scale_color_manual(values = rep("black", 9)) +
  scale_size_manual(values = c(rep(1.5, 9))) + 
  annotation_logticks(color = "gray50", sides = "b") +
  coord_cartesian(xlim = c(1e-01, 1e+04), ylim = c(0, 2)) +
  theme_light() +
  theme(plot.margin = grid::unit(c(3,3,-1,0), "mm"),
        axis.title.x = element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none",
        legend.background = element_rect(fill = alpha(0.8)),
        legend.title = element_blank(),
        legend.direction = "horizontal",
        strip.background = element_blank(),
        strip.text = element_blank(),
        panel.border = element_rect(color = "gray50"),
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        text = element_text(family = "serif")) # windowsFonts()$serif is TT Times New Roman

g.fishing
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/selection%20figure-1.png)<!-- -->
![selection figure plot](/figures/020_analysis/selection-figure.png)

Now we put the last two figures together using the package `cowplot`
which allows plots to be aligned.

``` r
g.methods <- plot_grid(g.fishing, g.spectrum,
                           align = "v", ncol = 1,
                           rel_heights = c(0.25, 0.75))
g.methods
```

![](C:/Users/jonat/AppData/Local/Temp/Rtmpc1pAhR/preview-7314177153bd.dir/020_analysis_GitHub_files/figure-gfm/methods-1.png)<!-- -->

``` r
ggsave("methods.pdf",
  plot = g.methods,
  device = "pdf",
  path = file.path(here(), "figures"))
```

![methods plot](/figures/020_analysis/methods.png)

[^1]: Gulf of Maine Research Institute, Temple University. Currently:
    Technical University of Denmark. <jonathan.e.falciani@gmail.com>
